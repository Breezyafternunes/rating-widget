<!-- Include the SweetAlert CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.1.0/dist/sweetalert2.min.css">

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<!-- Code from the existing theme component that adds the "Rate" button -->
<script type="text/discourse-plugin" version="0.8">
  // Register the "Rate" button
  api.registerTopicFooterButton({
    id: "discourse-custom-topic-button",
    priority: 0,
    icon() {
      if (settings.custom_topic_button_icon.length) {
        return settings.custom_topic_button_icon;
      }
    },
    translatedLabel() {
      return settings.custom_topic_button_title;
    },
    translatedTitle() {
      return settings.custom_topic_button_label;
    },
    action() {
      // Call our custom function to show the popup
      showPopup();
    },
    dropdown() {
      return this.site.mobileView;
    },
    classNames: ["discourse-custom-topic-button"],
    dependentKeys: ["topic.id", "topic.title", "topic.slug"],
    displayed() {
      return settings.custom_topic_button_enabled;
    }
  });

  // Function to show the popup dialog
  function showPopup() {
    // Display SweetAlert popup
    Swal.fire({
      title: "Rate this post:",
      html: `
        <div class="rating-stars">
          <i class="star far fa-star" data-rating="1"></i>
          <i class="star far fa-star" data-rating="2"></i>
          <i class="star far fa-star" data-rating="3"></i>
          <i class="star far fa-star" data-rating="4"></i>
          <i class="star far fa-star" data-rating="5"></i>
        </div>
      `,
      showCancelButton: true,
      cancelButtonText: "Cancel",
      confirmButtonText: "Submit",
      allowOutsideClick: true,
      focusConfirm: false,
      preConfirm: () => {
        // Function to save the rating via the Discourse API
        const ratingValue = $(".rating-stars .star.active").data("rating");
        const ratingField = "rating";
        api.ajax(`/posts/${postID}/custom_fields`, {
          type: "PUT",
          data: {
            custom_fields: {
              [ratingField]: ratingValue.toString(),
            },
          },
        });
      },
    }).then((result) => {
      if (!result.isCanceled && result.value) {
        // ... Additional code if needed ...
      }
    });
  }

  // Add a click event handler to the rate button using the class selector
  $(".rate-button").click(function () {
    // Call the showPopup() function when the button is clicked
    showPopup();
  });
</script>
