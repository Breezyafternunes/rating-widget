<!-- Code from the existing theme component that adds the "Rate" button -->
<script type="text/discourse-plugin" version="0.8">
  const currentUser = api.getCurrentUser();

  api.registerTopicFooterButton({
    id: "discourse-custom-topic-button",
    priority: 0,
    icon() {
      if (settings.custom_topic_button_icon.length) {
        return settings.custom_topic_button_icon;
      }
    },
    translatedLabel() {
      return settings.custom_topic_button_title;
    },
    translatedTitle() {
      return settings.custom_topic_button_label;
    },
    action() {
      const topicButtonUrl = settings.custom_topic_button_url;
      let url = topicButtonUrl

      if (this.topic) {
        url = url
          .replace("<TOPIC_ID>", this.topic.id)
          .replace("<TOPIC_TITLE>", this.topic.title)
          .replace("<TOPIC_SLUG>", this.topic.slug);
      }

      if (currentUser) {
        url = url
          .replace("<USER_ID>", currentUser.id)
          .replace("<USERNAME>", currentUser.username)
      }

      window.open(url, "_blank");
    },
    dropdown() {
      return this.site.mobileView;
    },
    classNames: ["discourse-custom-topic-button"],
    dependentKeys: ["topic.id", "topic.title", "topic.slug"],
    displayed() {
      return settings.custom_topic_button_enabled;
    }
  });
</script>



<!-- Pop-up dialog HTML -->
<div id="ratingDialog" class="modal" style="display: none;">
  <!-- ... (rest of the pop-up dialog content) ... -->
  <!-- Pop-up dialog HTML -->
<div id="ratingDialog" class="modal" style="display: none;">
  <div class="modal-content">
    <h2>Rate this post:</h2>
    <div class="rating-stars">
      <i class="star far fa-star" data-rating="1"></i>
      <i class="star far fa-star" data-rating="2"></i>
      <i class="star far fa-star" data-rating="3"></i>
      <i class="star far fa-star" data-rating="4"></i>
      <i class="star far fa-star" data-rating="5"></i>
    </div>
    <button class="submit-button">Submit</button>
  </div>
</div>
  <!-- ... (end of the pop-up dialog content) ... -->
  <button class="submit-button">Submit</button>
</div>

<!-- JavaScript function to show the pop-up dialog and handle rating -->
<script>
  function showRatingDialog(postID, topicID) {
    // Show the pop-up dialog when the button is clicked
    $("#ratingDialog").show();

    // Handle the rating stars interaction
    $(".rating-stars .star").hover(
      function () {
        $(this).prevAll(".star").addClass("active");
        $(this).addClass("active");
      },
      function () {
        $(this).prevAll(".star").removeClass("active");
        $(this).removeClass("active");
      }
    );

    // Handle the submit button click
    $(".submit-button").click(function () {
      // Get the selected rating value
      const ratingValue = $(".rating-stars .star.active").data("rating");

      // Hide the pop-up dialog after submission
      $("#ratingDialog").hide();

      // Function to save the rating via the Discourse API
      const ratingField = "rating";
      api.ajax(`/posts/${postID}/custom_fields`, {
        type: "PUT",
        data: {
          custom_fields: {
            [ratingField]: ratingValue.toString(),
          },
        },
      });
    });
  }
</script>
