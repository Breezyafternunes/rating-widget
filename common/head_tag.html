<!-- Include the SweetAlert CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.1.0/dist/sweetalert2.min.css">

<!-- Code from the existing theme component that adds the "Rate" button -->
<script type="text/discourse-plugin" version="0.8">
  // Register the "Rate" button
  api.registerTopicFooterButton({
    id: "discourse-custom-topic-button",
    priority: 0,
    icon() {
      if (settings.custom_topic_button_icon.length) {
        return settings.custom_topic_button_icon;
      }
    },
    translatedLabel() {
      return settings.custom_topic_button_title;
    },
    translatedTitle() {
      return settings.custom_topic_button_label;
    },
    action() {
      // Call our custom function to show the popup
      showPopup();
    },
    dropdown() {
      return this.site.mobileView;
    },
    classNames: ["discourse-custom-topic-button"],
    dependentKeys: ["topic.id", "topic.title", "topic.slug"],
    displayed() {
      return settings.custom_topic_button_enabled;
    }
  });

  // Function to show the popup dialog
  function showPopup() {
    // Display SweetAlert popup
    Swal.fire({
      title: "Rate this post:",
      html: `
        <div class="rating-stars">
          <i class="star far fa-star" data-rating="1"></i>
          <i class="star far fa-star" data-rating="2"></i>
          <i class="star far fa-star" data-rating="3"></i>
          <i class="star far fa-star" data-rating="4"></i>
          <i class="star far fa-star" data-rating="5"></i>
        </div>
      `,
      showCancelButton: true,
      cancelButtonText: "Cancel",
      confirmButtonText: "Submit",
      allowOutsideClick: true,
      focusConfirm: false,
      preConfirm: () => {
        // Handle the rating value when the "Submit" button is clicked
        const ratingValue = $(".rating-stars .star.selected").data("rating");
        if (!ratingValue) {
          Swal.showValidationMessage("Please select a rating!");
        }
        return ratingValue;
      },
    }).then((result) => {
      if (!result.isCanceled && result.value) {
        // Handle the rating value after the user selects a rating and clicks "Submit"
        const ratingValue = result.value;
        const postID = $(".rate-button").data("post-id");
        saveRating(postID, ratingValue);
      }
    });
  }

  // Handle the rating stars interaction in the popup
  $(document).on("mouseenter", ".star", function () {
    $(this).prevAll(".star").addClass("hover");
    $(this).addClass("hover");
  });

  $(document).on("mouseleave", ".star", function () {
    $(this).prevAll(".star").removeClass("hover");
    $(this).removeClass("hover");
  });

  $(document).on("click", ".star", function () {
    $(this).siblings(".star").removeClass("selected");
    $(this).addClass("selected");
  });
