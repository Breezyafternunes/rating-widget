<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.1.0/dist/sweetalert2.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.1.0/dist/sweetalert2.min.css">

<!-- Code from the existing theme component that adds the "Rate" button -->
<script type="text/discourse-plugin" version="0.8">
  // Register the "Rate" button
  api.registerTopicFooterButton({
    id: "discourse-custom-topic-button",
    priority: 0,
    icon() {
      if (settings.custom_topic_button_icon.length) {
        return settings.custom_topic_button_icon;
      }
    },
    translatedLabel() {
      return settings.custom_topic_button_title;
    },
    translatedTitle() {
      return settings.custom_topic_button_label;
    },
    action() {
      // Show the SweetAlert popup when the button is clicked
      Swal.fire({
      title: 'Rate this post',
      html: `
        <div class="rating-stars">
          <i class="far fa-star" data-rating="1"></i>
          <i class="far fa-star" data-rating="2"></i>
          <i class="far fa-star" data-rating="3"></i>
          <i class="far fa-star" data-rating="4"></i>
          <i class="far fa-star" data-rating="5"></i>
        </div>
      `,
      showCloseButton: true,
      showCancelButton: false,
      showConfirmButton: false,
      customClass: {
        popup: "custom-popup",
      },
      onOpen: () => {
        // Handle the rating stars interaction
        $(".rating-stars .far").hover(
          function () {
            $(this).addClass("fas").removeClass("far"); // Change empty star to colored star on hover
            $(this).prevAll(".far").addClass("fas").removeClass("far"); // Change previous empty stars to colored stars
          },
          function () {
            $(this).addClass("far").removeClass("fas"); // Change colored star to empty star when not hovered
            $(this).prevAll(".fas").addClass("far").removeClass("fas"); // Change previous colored stars to empty stars
          }
        );
          // Handle the submit button click
          $(".submit-button").click(function () {
            // Get the selected rating value
            const ratingValue = $(".rating-stars .fas.active").data("rating");

            // Close the popup dialog after submission
            Swal.close();

            // Call the function to save the rating (You can implement this part later)
            // saveRating(postID, ratingValue);
          });
        },
      });
    },
    dropdown() {
      return this.site.mobileView;
    },
    classNames: ["discourse-custom-topic-button"],
    dependentKeys: ["topic.id", "topic.title", "topic.slug"],
    displayed() {
      return settings.custom_topic_button_enabled;
    }
  });
</script>
